---
title: 트랜잭션과 회복
tags: 데이터베이스 도서
article_header:
type: cover
---
# [1] 트랜잭션

---

<br><br>

## 1-1. 트랜잭션의 개념

---

데이터베이스는 다수의 사용자가 동시에 사용하더라도 모순이 없는 정확성을 유지해야 한다. 또한, 장애가 발생할시 정확하고 일관된
상태로 복구가 가능해야 한다. 이러한 기능을 수행하는게 **트랜잭션**이다.

### 트랜잭션

> 작업 하나를 수행하는 데 필요한 데이터베이스의 연산들을 모아놓은 것, 데이터베이스의 논리적 작업의 단위


<br><br>

## 1-2. 트랜잭션의 특성

---

트랜잭션이 성공적으로 처리되어 데이터베이스의 무결성과 일관성이 보장되려면 네 가지 특성을 만족해야 한다.
흔히 이를 **ACID** 특성이라고 한다.

### 1. 원자성(Atomicity)

### 2. 일관성(Consistency)

### 3. 격리성(Isolation)

### 4. 지속성(Durability)

<br><br>

### 원자성(Atomicity)

---

원자성은 트랜잭션을 구성하는 연산들이 모두 정삭적으로 실행되거나 하나도 실행되지 않아야 한다는 **ALL-OR-NOTHING** 방식을 의미한다.

트랜잭션 수행중 장애가 발생한다면, 그 전까지 수행한 연산을 모두 취소하고 초기상태로 되돌려 놓는 트랜잭션의 원자성을 보장해야 한다.

<br><br>

### 일관성(Consistency)

---

일관성은 트랜잭션이 성공적으로 수행된 후에도 데이터베이스가 일관된 상태를 유지해야 함을 의미한다. 트랜잭션이 수행되는 과정에서는 일시적으로 일관된
상태가 아닐 수 있지만 트랜잭션의 수행이 성공적으로 완료된 후에는 데이터베이스가 일관된 상태를 유지해야 한다.

<br><br>

### 격리성(Isolation)

---

현재 수행 중인 트랜잭션이 완료될 떄까지 트랜잭션이 생성한 중간 연산 결과에 다른 트랜잭션이 접근 할 수 없을을 뜻한다.

<br><br>

### 지속성(Durability)

---

트랜잭션이 성공적으로 완료된 후 데이터베이스에 반영한 수행 결과는 어떠한 경우에도 손실되지 않고 영구적이어야 함을 의미한다.

<br><br>

### 트랜잭션의 특성을 지원하는 DBMS의 기능

---

* 원자성, 지속성 -> 회복기능 제공
* 일관성, 격리성 -> 병행 제어 기능 제공

<br><br>
<br><br>

## 1-3. 트랜잭션의 연산

---

트랜잭션의 수행과 관련하여 주로 사용되는 연산에는 작업 완료를 의미하는 **commit**연산과 작업 취소를 의미하는 **rollback**연산이 있다.

### 작업 취소 -> Rollback

### 작업 완료 -> Commit

<br><br>
<br><br>

## 1-4. 트랜잭션의 상태

---

![](https://raw.githubusercontent.com/jickDo/picture/master/Book/DB/ts_state.png)


트랜잭션은 위 그림의 다섯 가지 상태 중 하나에 속하게 된다.

### 활성

> 트랜잭션이 수행되기 시작하여 현재 수행 중인 상태

<br>

### 부분 완료

> 트랜잭션이 활성화 상태에서 마지막 연산이 실행된 직후의 상태를 **부분 완료** 라고 한다. 트랜잭션이 모든 연산을 처리한 상태이다.
> 최종 결과를 데이터베이스에 반영하지 않은 상태이기 때문에 성공했다고 볼수 없고 **완료**상태가 아닌 **부분 완료**라고 명칭한다.


<br>

### 완료 상태

> 트랜잭션이 성공적으로 commit연산을 실행한 상태이다.

<br>

### 실패 상태

> 하드웨어, 소프트웨어, 트랜잭션 오류등 여러 이유로 인해 장애가 발생하여 트랜잭션의 수행이 중단된 상태를 실패 상태라고 한다.

<br>

### 철회 상태

> 트랜잭션을 수행하는데 실패하여 rollback 연산을 실행한 상태를 **철회** 상태라고 한다.


<br><br><br>

# [2] 장애와 회복

---

트랜잭션의 특성을 보장하고, 데이터베이스를 모순이 없는 일관된 상태로 유지하기 위해서는 **회복 기능**이 필요하다.

여기서 말하는 **회복**이란,
> 데이터 베이스가 장애가 발생하기 전의 일관된 상태로 복구시키는 것을 말한다.


<br><br>

## 2-1. 장애의 유형

---

**장애**란 무엇일까?

> 시스템이 제대로 동작하지 않는 상태를 총칭 **장애**라고 부른다.

<br><br>

## 2-2. 데이터베이스의 저장 연산

---

데이터베이스는 기본적으로 저장 장치에 저장된다. 그리고 저장 장치는 장애가 발생했을 때 대응하는 방법에 따라 세 종류가 있다.

| 저장장치                   |     | 설명                                                                    |
|------------------------|-----|-----------------------------------------------------------------------|
| 휘발성(Volatile) 저장장치     | 의미  | 장애가 발생하면 저장된 데이터가 손실됨                                                 |
|                        | 예   | 메인 메모리 등                                                              |
| 비휘발성(NonVolatile) 저장장치 | 의미  | 장애가 발생해도 저장된 데이터가 손실되지 않음. 단 디스크 헤더 손상같은 저장 장치 자체에 이상이 발생하면 문제가 생길수있음 |
|                        | 예   | 디스크, 자기테이프, CD/DVD                                                    |
| 안정(Stable) 저장장치        | 의미  | 비휘발성 저장 자치를 이용해 데이터 복사본을 여러개 만드는 방법                                   |

<br>

일반적으로 데이터베이스는 비휘발성 저장 장치인 **디스크**에 존재한다. 하지만 트랜잭션이 데이터베이스의 데이터를 처리하려면
데이터를 디스크에서 메인 메모리로 가져와 이를 처리한 후 그 결과를 다시 디스크로 보내는 작업이 필요하다.

<br><br>

![](https://raw.githubusercontent.com/jickDo/picture/master/Book/DB/td_flow.png)

디스크와 메인 메모리 간의 데이터 이동은 **블록** 단위로 수행된다. 디스크에 있는 블록을 **디스크 블록** 이라고 하고, 메인메모리에 있는
블록은 **버퍼 블록**이라 한다. 디스크와 메인 메모리 간의 데이터 이동은 다음 두 연산으로 수행한다.

### 1. input(x)

> 디스크 블록에 저장되어 있는 데이터 X를 메인 메모리 버퍼 블록으로 이동 시키는 연산
> 쉽게 생각해서 트랜잭션 기준으로 값을 사용하기 위한 연산이다.

### 2. output(x)

> 메인 메모리 버퍼 블록에 저장되어 있는 데이터 X를 프로그램의 변수로 읽어오는 연산
> 트랜잭션 기준으로 값을 저장하기 위해 사용되는 연산.

<br><br>
<br><br>

우리가 사용하는 **응용 프로그램과** **메인 메모리간의** 연산에도 두가지 연산이 작용한다.

### 1. read(x)

> 메인 메모리 버퍼 블록에 저장되어 있는 데이터 X를 프로그램의 변수로 읽어 오는 연산

### 2. write(x)

> 프로그램의 변수 값을 메인 메모리 버퍼 블록에 있는 데이터 X에 기록하는 연산

<br><br>

## 2-3. 회복 기법

---

데이터베이스의 회복의 핵심 원린느 **데이터 중복**이다.

데이터를 별도의 장소에 미리 복사해두고, 장애로 문제가 발생했을 때 복사본을 이용해 원래의 상태로 복원하는 것이다. 이러한 데이터베이스
회복에는 **두가지** 방법이 있다.

<br><br>

### 데이터베이스 회복을 위해 복사본을 만드는 방식

---

### 1. 덤프(dump)

> 데이터베이스 전체를 다른 저장 장치에 주기적으로 복사하는 방법

### 2. 로그(log)

> 데이터베이스에서 변경 연산이 실행될 때마다 데이터를 변경하기 이전 값과 변경한 이후의 값을 별도의 파일에 기록하는 방법

<br><br>

### 데이터베이스 회복 연산

---

덤프나 로그 방법으로 중복 저장한 데이터를 이용해 데이터베이스를 복구하는 가장 기본적인 방법은 **redo** 혹은 **undo** 이다.

<br>

### 1. redo(재실행)

> 가장 최근에 저장한 데이터베이스 복사본을 가져온 후 로그를 이용해 복사본이 만들어진 이후에 실행된 모든 변경 연산을
> 재실행하여 장애가 발생하기 직전의 데이터베이스 상태로 복구

### 2. undo(취소)

> 로그를 이용해 지금까지 실행된 모든 변경 연산을 취소하여 데이터베이스를 원래의 상태로 복구

<br><br>

위에서도 볼수 있듯이, redo 와 undo 연산에서는 로그가 중요하게 사용된다.

로그는 변경 연산 전,후를 기록한 것이고,
그것을 저장한 파일을 **로그 파일**이라고 하고 그것의 기록 단위를 **로그 레코드** 라고 한다.

<br><br>

### 로그 레코드의 종류

---

| 로그 레코드                    |     | 설명                                               |
|---------------------------|-----|--------------------------------------------------|
| <Tn,start>                | 의미  | 트랜잭션 Tn가 수행을 시작했음을 기록                            |
|                           | 예   | <T1,start>                                       |
| <Tn, old_value,new_value> | 의미  | 트랜잭션 Tn가 데이터 X를 이전 값에서 새로운 값으로 변경하는 연산을 실행했음을 기록 |
|                           | 예   | <T1, X,10000,5000>                               |
| <Tn, commit>              | 의미  | 트랜잭션 Tn가 성공적으로 완료되었음을 기록                         |
|                           | 예   | <T1, commit>                                     |
| <Tn, abort>               | 의미  | 트랜잭션 Tn가 철회되었음을 기록                               |
|                           | 예   | <T1, abort>                                      |


<br><br>

## 데이터 베이스 회복 기법

---

앞서 보았던 회복 기법 의외에도 실제로 데이터베이스 관리 시스템은 좀 더 복잡하고 효울적인 회복 기법들을 사용한다. 데이터베이스 회복의 기본 연산으로
설명하였던 **redo** 와 **undo**도 데이터베이스 관리 시스템이 실제로 적용하는 회복 기법에서 사용한다.

### 1. 로그 회복 기법

### 2. 검사 시점 회복 기법

### 3. 미디어 회복 기법

여기서 중요하게 볼 내용은 **로그 회복 기법**이며 나머지도 간단하게나마 설명할 예정이다.

<br><br>

## 로그 회복 기법

---

로그를 이용한 회복 기법은 데이터를 변경한 연산 결과를 데이터베이스에 반영하는 시점에 따라

* 즉시 갱신 회복
* 지연 갱신 회복

두가지로 나뉜다.

<br><br>

### 즉시 갱신 회복이란?

---

즉시 갱신(immediate update)회복 기법은 트랜잭션 수행 중에 데이터를 변경한 연산의 결과를 데이터베이스에 즉시 반영한다.
또한, 장애 대응을 위한 변경 내용을 로그 파일에도 기록한다.

여기서, 정상적으로 로그를 사용하기 위해서는 **로그 파일 기록**이 **데이터 베이스 변경 연산** 보다 먼저 수행되어야 한다.
즉시 갱신 회복에서 장애가 발생하면 로그 파일을 참조하여 **redo** 혹은 **undo**를 사용하게 된다.

<br><br>

각각,

### undo 연산실행

> 트랜잭션이 완료되기 전에 장애가 발생한 경우
>
> 로그 파일에 <Tn, start> 로그 레코드는 존재하지만 <Tn, commit> 로그 레코드는 존재하지 않는 상태

### redo 연산실행

> 트랜잭션이 완료된 후에 장애가 발생한 경우
>
> 로그 파일에 <Tn, start> 로그 레코드와 <Tn, commit> 로그 레코드가 모두 존재하는 상태

<br><br>

### 지연 갱신 회복이란?

---

지연 갱신(deferred update)회복 기법은 트랜잭션이 수행되는 동안에는 데이터 변경 연산의 결과를 데이터베이스에 즉시 반영하지
않고 로그 파일에만 기록해두었다가, 트랜잭션이 부분 완료된 후에 로그에 기록된 내용을 이용해 데이터베이스에 한 번에 반영한다.

지연 갱신 회복에서 장애가 발생하면 로그 파일을 참조하여 **redo** 만 사용하게 된다.

<br><br>

각각,

### 로그 내용을 무시하고 버림

> 트랜잭션이 완료되기 전에 장애가 발생한 경우
>
> 로그 파일에 <Tn, start> 로그 레코드는 존재하지만 <Tn, commit> 로그 레코드는 존재하지 않는 상태

### redo 연산실행

> 트랜잭션이 완료된 후에 장애가 발생한 경우
>
> 로그 파일에 <Tn, start> 로그 레코드와 <Tn, commit> 로그 레코드가 모두 존재하는 상태


<br><br>

## 검사 시점 회복 기법

---

로그을 이용한 회복 기법은 로그 전체를 분석하여 **redo** 나 **undo**를 수행하는데, 이러한 경우 회복에 많은 시간이 걸리고
리소스 사용도 많이 하기 때문에 **검사 시점 회복 기법**에서는 **체크포인트**를 생성한다.

장애가 발생하면 가장 최근 검사 시점 이전의 트랜잭션에는 회복 작업을 수행하지 않고, 이후의 트랜잭션에만 회복
작업을 수행한다. 검사 시점 회복 기법을 이용하면 회복 작업의 범위가 검사 시점으로 정해지므로 불필요한 회복을 하지 않아도 된다.

<br><br>

## 미디어 회복 기법

---

하드웨어 적인 디스크에 장애가 발생할 때 대비한 회복 기법이 **미디어 회복 기법**이다.

전체 데이터베이스의 내용을 일정 주기마다 다른 안전한 저장 장치에 복사해두는 **덤프**방식을 이용한다.

































