---
title: 멀티 쓰레드 프로그래밍의 동시성 이슈와 Thread-Safe 설계 방법
tags: 운영체제
article_header:
type: cover
---

## 동시성 이슈란?

---

<br>

![](https://raw.githubusercontent.com/jickDo/picture/master/OS/study/cp2/11/concurrency.png)

<br>

동시성 이슈란 하나의 자원에 대해 여러 스레드가 접근할때 발생합니다.

예를 들어, 좋아요가 10 인 자원에 대해 스레드 a와 b가 동시에 접근해서 좋아요 10에 대한 값을 가져옵니다.
스레드 a는 좋아요 카운트를 하나 늘리는 행위를 하고 스레드 b는 좋아요 카운트를 하나 줄이는 행위를 할때
스레드 a가 좋아요 카운트를 늘리면 11가 됩니다. 하지만 스레드 a와 b는 좋아요 카운트에 동시에 접근해서 초기값 10을 받은 상태라면
스레드 b는 늘어난 11라는 숫자대신 10을 기준으로 값을 줄이게 됩니다. 그럼 최종 결과는 10이 아닌 9라는 값으로 나오게 됩니다.

이처럼 멀티 스레드 환경에서는 하나의 자원에 동시에 접근하게 되면 이러한 문제가 발생할 수 있습니다.

<br>
<br>

## 스레드 안전

---

그럼 우리가 추구해야 할 문제는 스레드 안전한 멀티 스레드 프로그래밍을 구현할 수 있어야 한다. 이것을 구현하는
방법에 대해 이야기 하려고 합니다.

<br>
<br>

## 스레드 안전 여부 판단

---

1. 전역 변수나 힙, 파일과 같이 여러 스레드가 동시 접근 가능한 자원을 사용하는가
2. 핸들과 포인터를 통한 데이터의 간접 접근이 가능한가?
3. 부수 효과를 가져오는 코드가 있는가?

<br>
<br>

## 스레드 안전을 지키기 위한 4가지 방법

---

1. 상호 배제(Mutual Exclusion)

<br>

- 공유 자원에 하나의 Thread만 접근할 수 있도록 세마포어/ 뮤텍스락을 통제하는 방법입니다.

<br>

2. 원자 연산(Atomic Operation)

<br>

- 공유 자원에 접근할 때 원자 연산을 이용하거나 원자적으로 정의된 접근 방법을 사용함으로써 상호 배제를 구현하는 방법입니다.
- Atomic
  - 공유 자원 변경에 필요한 연산을 원자적으로 분리한 뒤에 실제로 데이터의 변경이 이루어지는 시점에 Lock을 걸고,
    데이터를 변경하는 시간 동안 다른 쓰레드의 접근이 불가능하도록 하는 방법입니다.

<br>

3. Thread-Local Storage (스레드 지역 저장소)

<br>

- 공유 자원의 사용을 최대한 줄이고 각가의 쓰레드에서만 접근 가능한 저장소들을 사용함으로써 동시 접근을 막는 방법입니다.
- 일반적으로 공유 상태를 피할 수 없을 때 사용하는 방식이며, 전역 변수 사용을 자제하라는 뜻으로 생각하면 됩니다.

<br>

4. Re-entrancy (재진입성)

<br>

- 쓰레드 호출과 상관 없이 프로그램에 문제가 없도록 작성하는 방법입니다.
- 어떤 함수가 한 스레드에 의해 호출되어 실행 중이라면 다른 스레드가 그 함수를 호출하더라도 그 결과가 각각에게 옳바르게 주어져야 합니다.
- 쓰레드끼리 독립적으로 동작할 수 있도록 코드를 작성하는 것으로 생각하면 됩니다.

<br>
<br>




